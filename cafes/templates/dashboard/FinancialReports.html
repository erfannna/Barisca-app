{% extends "dashboard/base.html" %}

<style>
    {% block style %}

    #pageContent {
        width: 77vmax;
    }
    #incomeDetail {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        flex-direction: row-reverse;
        justify-content: space-around;
        gap: 20px;
        margin: 30px 0 20px 0;
    }
    .TempsList {
        position: relative;
        display: flex;
        float: right;
        width: 22.2vmax;
        height: 65px;
        /*margin: 30px 0 5px 10px;*/
        padding: 10px;
        background-color: #db8585;
        border: solid #e9cbcb;
        border-radius: 10px;
        justify-content: center;
        flex-direction: column;
        align-items: center;
        cursor: default;
        user-select: none;
        transition: .2s;
        scale: 0.5;
        animation: s3 .5s forwards;
    }
    .TempsList:hover {
        scale: 1.2 !important;
        transform: rotate3d(1, 2, 0, 20deg);
        filter: drop-shadow(2px 4px 6px #a785db);
    }
    .cProsCat {
        font-family: vazir;
        font-weight: 600;
        color: white;
        background-color: #ffffff24;
        border-radius: 50%;
        padding: 50px;
        direction: rtl;
    }
    .label {
        color: black;
    }
    .price {
        font-size: 22px;
        font-family: shabnam;
        color: white;
        text-shadow: 2px 1px 1px black;
    }
    #sections {
        position: relative;
        display: flex;
        direction: rtl;
        float: right;
        width: 100%;
        margin-top: 20px;
        justify-content: flex-start;
        gap: 5px;
        padding-right: 5px;
        border-bottom: #ac77ff 2px solid;
        align-items: center;
    }
    .sectionLabel {
        height: 100%;
        font-size: 16px;
        font-family: Shabnam;
        font-weight: 600;
        text-decoration: none;
        background-color: #ac77ffa5;
        padding: 5px 30px;
        border-radius: 12px 12px 0 0;
        color: white;
        cursor: pointer;
    }
    .sectionSelected {
        background-color: #ac77ff;
        border-right: 3px solid darkslategray;
        cursor: default;
    }
    #loaded {
        position: relative;
        display: flex;
        flex-wrap: wrap;
        width: 100%;
        justify-content: space-between;
        flex-direction: row-reverse;
    }
    .orderList {
        position: relative;
        width: 100%;
        /*width: 37.2vmax;*/
        float: right;
        filter: grayscale(.9);
    }
    .oPros {
        position: relative;
        margin-left: 15px;
        margin-top: 10px;
        float: right;
        padding: 2px 12px;
        font-family: vazir;
        font-size: 14px;
        font-weight: 100;
        background-color: white;
        border-radius: 15px;
        cursor: default;
        transition: .2s;
    }
    .oTempsList {
        position: relative;
        overflow: auto;
        margin-top: 15px;
        padding: 10px;
        background-color: #d8bfd887;
        border-radius: 10px;
    }
    .oDateGroup {
        position: relative;
        width: 99.5%;
        margin-left: auto;
        margin-right: auto;
        float: right;
        margin-top: 10px;
        margin-bottom: 10px;
        text-align: center;
        padding: 2px 5px;
        background-color: sienna;
        opacity: 80%;
        border-radius: 0 0 10px 10px;
        color: white;
        font-family: shabnam;
        cursor: default;
    }
    .oProsCat {
        position: relative;
        margin-left: 5px;
        padding: 1.5px 5px;
        float: right;
        font-family: shabnam;
        font-weight: 500;
        color: white;
        opacity: 70%;
        background-color: chocolate;
        border-radius: 9px;
        cursor: default;
    }
    .pNum {
        position: absolute;
        width: 20px;
        height: 20px;
        left: -10px;
        top: -10px;
        color: white;
        background-color: darkred;
        border-radius: 50%;
        font-family: Shabnam;
        font-weight: 400;
        text-align: center;
        opacity: 80%;
    }
    .reservesList {
        position: relative;
        width: 100%;
        /*width: 37.2vmax;*/
        float: right;
        filter: grayscale(.9);
    }
    .costsList {
        position: relative;
        width: 100%;
        float: right;
        filter: grayscale(.9);
    }
    .xlsxList {
        position: relative;
        width: 100%;
        float: right;
        filter: grayscale(.9);
    }
    .reserveDetail {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        width: 58%;
        margin: 0 5px 0 5px;
        padding: 5px;
        float: right;
        font-family: shabnam;
        font-size: 18px;
        font-weight: 600;
        color: maroon;
        background-color: white;
        border-radius: 9px;
        cursor: default;
    }
    .resDetail {
        margin-bottom: 5px;
        direction: rtl;
        font-size: 16px;
        font-weight: 400;
        color: black;
    }
    .resEnd {
        width: 33%;
    }
    .downBtn {
        position: absolute;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: space-evenly;
        width: 15px;
        height: 15px;
        color: white;
        background-color: #ac77ff;
        border-radius: 10px 10px 0 0;
        padding: 5.5px;
        text-align: center;
        font-family: vazir;
        font-size: 15px;
        top: 7.5px;
        left: 12px;
        cursor: pointer;
        text-decoration: none;
        transition: .2s;
    }
    .changeBtn {
        display: none;
    }
    .downBtn:hover {
        width: 140px;
        filter: drop-shadow(0px 0px 6px lightgray);
    }
    .downBtn:hover .changeBtn {
        display: block;
    }
    .popUpBg {
        position: absolute;
        display: none;
        top: 0;
        width: 100%;
        height: 100%;
        backdrop-filter: grayscale(.5) blur(1px);
    }
    .delBtn:hover {
        background-color: mediumpurple !important;
        border-style: solid;
        border-width: 2px;
        border-color: #dcdcdc !important;
    }
    #newReport {
        position: absolute;
        display: none;
        top: 110px;
        right: 30%;
        filter: drop-shadow(0px 0px 8px rgba(160, 160, 160, .3));
        width: min-content;
        flex-direction: column;
        align-items: center;
        background-color: white;
        padding: 15px;
        border-radius: 13px;
    }
    #mForm {
        background-color: white;
        max-width: unset;
        width: unset;
        align-items: center;
        margin-top: unset;
    }
    #downRep {
        display: none;
        position: relative;
        margin-top: 15px;
        margin-bottom: 15px;
        padding: 2px 30px;
        font-size: 15px;
        font-family: vazir;
        font-weight: 550;
        color: white;
        background-color: #77a4ff;
        border-radius: 8px;
        text-decoration: none;
        border-style: solid;
        border-width: 2px;
        border-color: white;
        cursor: pointer;
        transition: .3s;
    }
    .success {
        display: none;
        position: relative;
        font-family: vazir;
        font-weight: 600;
        margin-top: 30px;
    }
    #aClose {
        float: unset;
        width: auto;
        padding: 1px 12px;
        font-weight: 100;
        text-align: center;
        color: white;
        background-color: grey;
        font-family: vazir;
        border-radius: 15px;
        border-style: solid;
        border-width: 2px;
        border-color: white;
        cursor: pointer;
        transition: .1s;
    }
    .custom-loader {
        display: none;
        width:25px;
        height:25px;
        margin-top: 30px;
        margin-bottom: 15px;
        border-radius:50%;
        border:4px solid;
        border-color:#FFCF9B;
        border-right-color: #C36328;
        animation:s2 1s infinite linear;
    }
    @keyframes s2 {to{transform: rotate(1turn)}}
    @keyframes s3 {to{scale: 1;}}
    @media only screen and (max-width: 430px) {
        #pageContent {
            width: 90%;
        }
        #reportDetail {
            float: right;
        }
        #loaded {
            float: right;
        }
        #incomeDetail {
            width: 100%;
            display: grid;
            float: right;
            justify-content: center;
            gap: 20px;
            margin: 30px 0 20px 0;
            align-items: center;
            justify-items: center;
            align-content: center;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        }
        .TempsList {
            font-size: 14px;
            width: 18vmax;
        }
        .cProsCat {
            width: max-content;
        }
        .price {
            font-size: 1em;
        }
        #newReport {
            top: 10%;
            left: 15%;
        }
        .sectionLabel {
            font-size: 12px;
            padding: 5px 18px;
        }
        .downBtn {
            left: 0;
            top: unset;
            bottom: 0;
            font-size: 12px;
            width: 12px;
            height: 12px;
        }
    }

    {% endblock %}
</style>

{% block content %}

<div id="pageContent">
    <h1 id="pTitle">گزارشات مالی کافه</h1>
    <div id="incomeDetail">
        <div class="TempsList">
            <div class="cProsCat"><span class="label">درآمد سال جاری</span><br><span class="price"><span style="font-size: 28px;">{{ income }}</span> تومان</span></div>
        </div>
        <div class="TempsList" style="background-color: #addb85;border: solid #d2f0b8;">
            <div class="cProsCat"><span class="label">درآمد ماه جاری</span><br><span class="price"><span style="font-size: 28px;">{{ monthly_income }}</span> تومان</span></div>
        </div>
        <div class="TempsList" style="background-color: #85b6db;border: solid #bfe3ff;">
            <div class="cProsCat"><span class="label">درآمد خالص ماه</span><br><span class="price"><span style="font-size: 28px;">{{ mNetIncome }}</span> تومان</span></div>
        </div>
        {% if reportType == 'orders' or reportType == 'xlsx'  %}
        <div class="TempsList" style="background-color: #dbaf85;border: solid #ffdebf;">
            <div class="cProsCat"><span class="label">درآمد سفارش سال</span><br><span class="price"><span style="font-size: 28px;">{{ total_orders }}</span> تومان</span></div>
        </div>
        <div class="TempsList" style="background-color: #85dbb4;border: solid #bfffed;">
            <div class="cProsCat"><span class="label">درآمد سفارش ماه</span><br><span class="price"><span style="font-size: 28px;">{{ monthly_orders }}</span> تومان</span></div>
        </div>
        <div class="TempsList" style="background-color: #a785db;border: solid #d0b8f0;">
            <div class="cProsCat"><span class="label">سفارش ها</span><br><span class="price"><span style="font-size: 28px;">{{ orders_num }}</span> عدد</span></div>
        </div>
        {% elif reportType == 'reservations' %}
        <div class="TempsList" style="background-color: #dbaf85;border: solid #ffdebf;">
            <div class="cProsCat"><span class="label">درآمد رزروی سال</span><br><span class="price"><span style="font-size: 28px;">{{ total_reserved }}</span> تومان</span></div>
        </div>
        <div class="TempsList" style="background-color: #85dbb4;border: solid #bfffed;">
            <div class="cProsCat"><span class="label">درآمد رزروی ماه</span><br><span class="price"><span style="font-size: 28px;">{{ monthly_reserved }}</span> تومان</span></div>
        </div>
        <div class="TempsList" style="background-color: #a785db;border: solid #d0b8f0;">
            <div class="cProsCat"><span class="label">رزروی ها</span><br><span class="price"><span style="font-size: 28px;">{{ reserved_num }}</span> عدد</span></div>
        </div>
        {% else %}
        <div class="TempsList" style="background-color: #dbaf85;border: solid #ffdebf;">
            <div class="cProsCat"><span class="label">هزینه های سال</span><br><span class="price"><span style="font-size: 28px;">{{ total_costs }}</span> تومان</span></div>
        </div>
        <div class="TempsList" style="background-color: #85dbb4;border: solid #bfffed;">
            <div class="cProsCat"><span class="label">هزینه های ماه</span><br><span class="price"><span style="font-size: 28px;">{{ monthly_costs }}</span> تومان</span></div>
        </div>
        <div class="TempsList" style="background-color: #a785db;border: solid #d0b8f0;">
            <div class="cProsCat"><span class="label">هزینه ها</span><br><span class="price"><span style="font-size: 28px;">{{ costs_num }}</span> عدد</span></div>
        </div>
        {% endif %}
    </div>
    <div id="sections"><a href="{% if reportType != 'orders' %}/reports{% endif %}" class="sectionLabel {% if reportType == 'orders' %}sectionSelected{% endif %}">سفارش ها</a><a href="{% if reportType != 'reservations' %}/reports/reservations{% endif %}" class="sectionLabel {% if reportType == 'reservations' %}sectionSelected{% endif %}">رزروی ها</a><a href="{% if reportType != 'costs' %}/reports/costs{% endif %}" class="sectionLabel {% if reportType == 'costs' %}sectionSelected{% endif %}">هزینه ها</a><a href="{% if reportType != 'xlsx' %}/reports/xlsx{% endif %}" class="sectionLabel {% if reportType == 'xlsx' %}sectionSelected{% endif %}">گزارش ها</a><span class="downBtn fi fi-rr-download"><span class="changeBtn">خروجی فایل اکسل</span></span></div>
    <div id="reportDetail">
        <div id="loaded">
            {% include "dashboard/reportsAJAX.html" %}
        </div>
        <div id="preload" style="display: none;"></div>
    </div>
    <div class="popUpBg"></div>
    <div id="newReport">
        <form id="mForm" method="post" enctype="multipart/form-data">
            <span class="nName fLabel">از تاریخ : <small>(پیشفرض = امروز) </small></span>
            {{ form.dateFrom }}
            <span class="nPrice fLabel">تا تاریخ : <small>(پیشفرض = امروز) </small></span>
            {{ form.dateTo }}
            <span class="nPrice fLabel">نوع گزارش : </span>
            {{ form.type }}
            {% csrf_token %}
            <input id="submit" class="nForm" type="submit" value="ایجاد گزارش">
        </form>
        <span id="loading" class="custom-loader"></span>
        <span id="success" class="success">.فایل اکسل گزارش ساخته شد</span>
        <span id="error" class="success">.ساخت گزارش با خظا مواجه شد</span>
        <a id="downRep" class="delBtn" href="" download="cafe-report">دانلود</a>
        <span id="aClose" class="delBtn">بستن</span>
    </div>
</div>

{% endblock %}

{% block domready %}

$(" .downBtn ").click(function(e) {
    $(" .popUpBg ").fadeIn(100);
    $(" #newReport ").fadeIn(100);
    $(" #newReport ").css('display', 'flex');
});

$(" #mForm ").submit(function(e) {
    e.preventDefault();
    $(" #submit ").hide();
    $(" #loading ").show();
    $(" #aClose ").hide(200);
    var serializedData = $(this).serialize();
    $.ajax({
        type: 'POST',
        url: "{% url 'cafes:nReport' %}",
        data: serializedData,
        success: function(response) {
            $(" #loading ").hide();
            $(" #success ").show(150);
            $(" #downRep ").attr("href", response["reportFile"]);
            $(" #downRep ").show(150);
            $(" #aClose ").show(150);
        },
        error: function(response){
            $(" #loading ").hide();
            $(" #error ").show(150);
        }
    });
});

$(" #aClose ").click(function(e) {
    e.preventDefault();
    $(" #mForm ").trigger('reset');
    $(" .popUpBg ").fadeOut(100);
    $(" #newReport ").fadeOut(100);
    $(" #success ").hide();
    $(" #error ").hide();
    $(" #downRep ").hide();
    $(" #submit ").show();
});

var page = 1;
var empty_page = false;
var block_request = false;

$(window).scroll(function() {
    var margin = $(document).height() - $(window).height() - 200;
    if  ($(window).scrollTop() > margin && empty_page == false && block_request == false) {
        block_request = true;
        page += 1;
        $.get('?page=' + page, function(data) {
            if(data == '') {
                empty_page = true;
            }
            else {
                $(" #preload ").append(data);
                let orders = $(" #preload ").children(" .orderList ");
                $(" #loaded ").children(" .orderList ").append(orders);
                $(" #preload ").children(" .orderList ").remove();
                let reserved = $(" #preload ").children(" .reservesList ");
                $(" #loaded ").children(" .reservesList ").append(reserved);
                $(" #preload ").children(" .reservesList ").remove();
                let costs = $(" #preload ").children(" .costsList ");
                $(" #loaded ").children(" .costsList ").append(costs);
                $(" #preload ").children(" .costsList ").remove();
                let reports = $(" #preload ").children(" .xlsxList ");
                $(" #loaded ").children(" .xlsxList ").append(reports);
                $(" #preload ").children(" .xlsxList ").remove();
                block_request = false;
            }
        });
    }
});

{% endblock %}
